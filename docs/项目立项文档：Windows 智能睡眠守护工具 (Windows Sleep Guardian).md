## **项目立项文档：Windows 智能睡眠守护工具 (Windows Sleep Guardian)**

### **1. 项目背景与业务调研**

#### **1.1 项目背景**

作为一款高性能游戏本（联想拯救者Y9000P 2022）的用户，我在日常使用中持续遭遇一个顽固的电源管理问题：**笔记本在合盖后经常无法正常进入睡眠状态，且在唤醒时出现黑屏、卡死或无法关机等异常现象**。通过系统内置的 `powercfg` 命令行工具诊断，发现问题根源常在于某些后台应用程序（如网易云音乐、浏览器标签）或驱动程序（如音频、网卡驱动）持续占用系统资源，阻止了睡眠状态的转换。

此问题并非个例，而是**Windows笔记本，特别是高性能机型的一个普遍痛点**。用户往往在合盖携带后，发现电脑在背包中异常发热、电量耗尽，或再次打开时系统已崩溃，导致工作数据丢失、使用体验大幅下降。

#### **1.2 业务调研与市场分析**

* **用户痛点**：
  
  1. **睡眠失败**：合盖后电脑无法进入低功耗睡眠状态，导致发热、耗电。
  2. **唤醒异常**：从睡眠状态恢复时，出现黑屏、死机，需强制重启。
  3. **排查困难**：普通用户缺乏使用 `powercfg`、`事件查看器` 等专业工具定位问题的能力。
  4. **管理繁琐**：即便知道是某个应用导致，也需要手动反复检查、关闭，过程枯燥且易遗忘。

* **现有解决方案缺口**：
  
  1. **Windows内置功能过于分散与隐蔽**：`powercfg`命令强大但专业性过强；电源选项中的“媒体共享”等设置深藏且逻辑晦涩；事件查看器日志难以解读。
  2. **缺乏主动式、一体化的管理工具**：市场缺少一款能够**主动预警、自动处理、并可视化记录睡眠健康状态**的轻量级工具。

* **项目价值**：
  
  1. **提升用户体验**：让电脑的“睡眠”和“唤醒”行为回归稳定可靠，减少数据丢失风险和意外困扰。
  2. **简化运维操作**：将复杂的命令行诊断转化为一键式检查和图形化建议。
  3. **数据化洞察**：通过长期记录，帮助用户了解自己电脑的睡眠模式和应用兼容性问题。

### **2. 功能模块设计**

本工具将围绕“**事前预防、事中控制、事后分析**”的核心逻辑，设计以下五个模块：

| 模块名称            | 核心功能                                                                                                                                                                      | 用户场景                                                             |
|:--------------- |:------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:---------------------------------------------------------------- |
| **1. 智能阻塞检测器**  | - **实时监控**：定期（如每30秒）或手动触发，调用 `powercfg /requests` 扫描。<br>- **精准识别**：解析结果，区分“显示”、“系统”、“执行”等不同类别的阻塞源。<br>- **应用关联**：将驱动程序阻塞（如`USB Audio 2.0`）关联到具体的用户进程（如`网易云音乐.exe`）。      | 用户在计划会议或离开前，点击“立即检查”，工具列表显示“网易云音乐正通过音频设备阻止睡眠”。                   |
| **2. 进程安全管理器**  | - **一键终止**：用户可选择终止工具列表出的、非核心的阻塞进程。<br>- **安全名单**：允许用户将必要进程（如安防软件、下载工具）加入白名单，避免误杀。<br>- **建议处理**：对系统核心进程或驱动造成的阻塞，提供如“更新声卡驱动”、“禁用网卡唤醒”等操作建议和快捷跳转链接。                         | 工具建议“Realtek音频驱动可能需更新”，并提供官网链接和禁用该设备唤醒的快捷按钮。                     |
| **3. 睡眠控制与验证器** | - **手动快速睡眠**：提供比系统菜单更可靠的“强制睡眠”按钮，它会在触发睡眠前自动执行一次阻塞检查。<br>- **睡眠后唤醒自检**：电脑从睡眠唤醒后，工具自动在后台运行简短诊断，检查唤醒过程是否产生系统错误日志（事件ID 109, 506）。<br>- **结果通知**：通过系统托盘通知，告知用户上次睡眠是否成功，唤醒是否正常。 | 用户点击“安全睡眠”，工具先清理后台音乐播放器，再让系统睡眠。第二天开盖后，收到通知：“上次睡眠成功，唤醒正常，耗时2.1秒。” |
| **4. 睡眠事件记录仪**  | - **自动化日志收集**：静默记录每次睡眠/唤醒、关机/开盖（通过系统事件ID 1, 42, 6005, 6006）的时间、结果和关键参数。<br>- **阻塞历史归档**：将每次检测到的阻塞应用和历史记录存入本地数据库。                                                          | 用户可在“历史记录”页面查看：“过去一周，`chrome.exe` 因视频标签共阻止睡眠12次。”                |
| **5. 数据可视化面板**  | - **健康度仪表盘**：展示睡眠成功率、平均唤醒时间等指标。<br>- **阻塞排行榜**：以图表形式展示最常“肇事”的应用和驱动程序。<br>- **时间线视图**：图形化展示每天的睡眠-唤醒周期和阻塞事件点。                                                               | 用户直观看到周末睡眠失败率高，是因为通宵挂游戏，从而调整使用习惯。                                |

### **3. 实现原理与技术方案**

#### **3.1 技术栈选择**

* **核心开发语言**：**C# (.NET Framework / .NET 6+)**
  * **理由**：与Windows系统深度集成，可方便地调用WMI、PowerShell、Windows API，并提供性能优异的Windows窗体或WPF图形界面。
* **辅助脚本**：**PowerShell**
  * **理由**：无缝调用并解析 `powercfg` 命令，高效查询Windows事件日志。
* **数据存储**：**SQLite 数据库**
  * **理由**：轻量级，单文件，无需配置，适合存储本地的历史记录和配置信息。
* **用户界面**：**WPF 或 WinUI 3**
  * **理由**：可创建现代、美观的桌面应用程序界面。

#### **3.2 核心模块实现原理**

1. **阻塞检测 (`PowerCfgExecutor`)**
   
   * 使用 `Process.Start()` 调用 `powercfg /requests` 命令。
   * 通过正则表达式解析返回的文本，将驱动程序实例ID（如 `USB\VID_31B2...`）与 `Get-WmiObject Win32_PnPEntity` 或 `Get-Process` 结合，映射为友好的设备名和进程名。

2. **进程管理 (`ProcessManager`)**
   
   * 对用户进程，使用 `Process.Kill()` 方法终止。
   * 对驱动级阻塞，通过封装 `powercfg /devicedisablewake` 命令或调用 `SetupAPI` 来修改设备电源管理属性。

3. **睡眠控制与验证 (`SleepController`)**
   
   * **触发睡眠**：调用 `SetSuspendState` API (`powrprof.dll`)，这是最接近硬件原生的睡眠指令。
   * **唤醒自检**：工具以系统服务或计划任务形式，设置唤醒后延迟启动。启动后，使用 `PowerShell Get-WinEvent` 查询过去几分钟内 `System` 日志中是否存在关键错误ID（如109， 506， 142）。

4. **事件记录与可视化 (`DataLogger & Dashboard`)**
   
   * **日志收集**：创建一个后台服务，订阅 `System.Management.ManagementEventWatcher` 来监听Windows事件。
   * **数据存储**：所有事件和检测结果结构化后存入SQLite表。
   * **可视化**：使用 `LiveCharts` 或 `OxyPlot` 等图表库，将SQLite中的数据绑定到WPF的图表控件进行展示。

#### **3.3 安全与可靠性设计**

* **权限管理**：所有需要管理员权限的操作（如修改设备唤醒设置、终止系统进程）将通过 `UAC` 提权，并在界面上明确标识。
* **防误杀机制**：终止进程前进行二次确认，并维护一个内置的“系统关键进程”保护名单。
* **资源占用**：后台监控采用低频率轮询和事件驱动相结合，确保CPU和内存占用极低（< 1% CPU， 50MB RAM）。

#### **3.4 部署与扩展性**

* **部署**：最终打包为单一的 `.exe` 安装包或便携版。
* **扩展性**：
  * 未来可增加**云同步配置**功能，在多台电脑间同步白名单和设置。
  * 可引入**简单的机器学习模型**，根据历史记录预测哪些新安装的应用可能导致睡眠问题。

此项目旨在填补Windows个人电脑电源管理工具的市场空白，通过技术手段将复杂的系统问题转化为简单的用户交互，显著提升数亿Windows用户的日常使用体验和能效管理水平。
